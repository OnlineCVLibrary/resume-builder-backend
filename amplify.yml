version: 0.2

phases:
  install:
    commands:
      - echo "20" > .nvmrc
      - nvm install 20
      - nvm use 20
  pre_build:
    commands:
      - npm ci --cache .npm --prefer-offline --legacy-peer-deps
      - echo "Checking cache bucket..."
      - aws s3 ls s3://resume-builder-backend-cache || echo "Cache bucket not found"
      - echo "Creating cache bucket if it doesn't exist..."
      - aws s3 mb s3://resume-builder-backend-cache --region eu-west-1 || echo "Bucket already exists or creation failed"
      - echo "Attaching IAM policy for cache bucket..."
      - |
        aws iam put-role-policy --role-name codebuild-resume-builder-backend-service-role --policy-name S3CacheAccess --policy-document '{
          "Version": "2012-10-17",
          "Statement": [
            {
              "Effect": "Allow",
              "Action": [
                "s3:GetObject",
                "s3:PutObject",
                "s3:ListBucket",
                "s3:CreateBucket"
              ],
              "Resource": [
                "arn:aws:s3:::resume-builder-backend-cache/*",
                "arn:aws:s3:::resume-builder-backend-cache"
              ]
            }
          ]
        }'
  build:
    commands:
      - npx ampx pipeline-deploy --branch $AWS_BRANCH --app-id $AWS_APP_ID
  post_build:
    commands:
      - echo "Build completed successfully"

cache:
  paths:
    - .npm/**/*
    - node_modules/**/*
    - amplify/.amplify/artifacts/cache/**/*