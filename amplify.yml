version: 0.2

phases:
  install:
    commands:
      - echo "20" > .nvmrc
      - nvm install 20
      - nvm use 20
  pre_build:
    commands:
      - echo "Checking cache bucket..."
      - aws s3 ls s3://resume-builder-backend-cache --region eu-west-1 || echo "Cache bucket not found"
      - echo "Attempting to create cache bucket..."
      - aws s3 mb s3://resume-builder-backend-cache --region eu-west-1 2>&1 | tee bucket_creation.log || echo "Bucket creation failed, check bucket_creation.log"
      - echo "Attaching IAM policy for cache bucket..."
      - |
        aws iam put-role-policy --role-name codebuild-resume-builder-backend-service-role --policy-name S3CacheAccess --policy-document '{
          "Version": "2012-10-17",
          "Statement": [
            {
              "Effect": "Allow",
              "Action": [
                "s3:GetObject",
                "s3:PutObject",
                "s3:ListBucket",
                "s3:CreateBucket"
              ],
              "Resource": [
                "arn:aws:s3:::resume-builder-backend-cache/*",
                "arn:aws:s3:::resume-builder-backend-cache"
              ]
            }
          ]
        }' 2>&1 | tee iam_policy.log || echo "IAM policy attachment failed, check iam_policy.log"
      - npm ci --cache .npm --prefer-offline --legacy-peer-deps
  build:
    commands:
      - npx ampx pipeline-deploy --branch $AWS_BRANCH --app-id $AWS_APP_ID
  post_build:
    commands:
      - echo "Build completed successfully"
      - echo "Bucket creation log:"
      - cat bucket_creation.log || echo "No bucket creation log available"
      - echo "IAM policy log:"
      - cat iam_policy.log || echo "No IAM policy log available"

cache:
  paths:
    - .npm/**/*
    - node_modules/**/*
    - amplify/.amplify/artifacts/cache/**/*